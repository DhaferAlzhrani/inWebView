import 'dart:ffi';
import 'dart:io';
import 'dart:typed_data';
import 'package:ffi/ffi.dart';


final Uint8List hardcodedRK = Uint8List.fromList([
0x54 ,0x65 ,0x73 ,0x74 ,0x41 ,0x72 ,0x6d ,0x2e ,0x54 ,0x65 ,0x73 ,0x74 ,0x41 ,0x72 ,0x6d ,0x2e ,
0x54 ,0x65 ,0x73 ,0x74 ,0x41 ,0x72 ,0x6d ,0x2e ,0x54 ,0x65 ,0x73 ,0x74 ,0x41 ,0x72 ,0x6d ,0x2e ,
0x15 ,0x59 ,0x42 ,0xf7 ,0x54 ,0x2b ,0x2f ,0xd9 ,0x00 ,0x4e ,0x5c ,0xad ,0x41 ,0x3c ,0x31 ,0x83 ,
0xd7 ,0x8e ,0xb4 ,0x98 ,0x96 ,0xfc ,0xd9 ,0xb6 ,0xc2 ,0x99 ,0xaa ,0xc2 ,0x83 ,0xeb ,0xc7 ,0xec ,
0xfe ,0x9f ,0x8c ,0x1b ,0xaa ,0xb4 ,0xa3 ,0xc2 ,0xaa ,0xfa ,0xff ,0x6f ,0xeb ,0xc6 ,0xce ,0xec ,
0x3e ,0x3a ,0x3f ,0x56 ,0xa8 ,0xc6 ,0xe6 ,0xe0 ,0x6a ,0x5f ,0x4c ,0x22 ,0xe9 ,0xb4 ,0x8b ,0xce ,
0x77 ,0xa2 ,0x07 ,0x05 ,0xdd ,0x16 ,0xa4 ,0xc7 ,0x77 ,0xec ,0x5b ,0xa8 ,0x9c ,0x2a ,0x95 ,0x44 ,
0xe0 ,0xdf ,0x15 ,0x4d ,0x48 ,0x19 ,0xf3 ,0xad ,0x22 ,0x46 ,0xbf ,0x8f ,0xcb ,0xf2 ,0x34 ,0x41 ,
0xf6 ,0xba ,0x84 ,0x1a ,0x2b ,0xac ,0x20 ,0xdd ,0x5c ,0x40 ,0x7b ,0x75 ,0xc0 ,0x6a ,0xee ,0x31 ,
0x5a ,0xdd ,0x3d ,0x8a ,0x12 ,0xc4 ,0xce ,0x27 ,0x30 ,0x82 ,0x71 ,0xa8 ,0xfb ,0x70 ,0x45 ,0xe9 ,
0xb7 ,0xd4 ,0x9a ,0x15 ,0x9c ,0x78 ,0xba ,0xc8 ,0xc0 ,0x38 ,0xc1 ,0xbd ,0x00 ,0x52 ,0x2f ,0x8c ,
0x39 ,0xdd ,0x28 ,0xee ,0x2b ,0x19 ,0xe6 ,0xc9 ,0x1b ,0x9b ,0x97 ,0x61 ,0xe0 ,0xeb ,0xd2 ,0x88 ,
0x7e ,0x61 ,0x5e ,0xf4 ,0xe2 ,0x19 ,0xe4 ,0x3c ,0x22 ,0x21 ,0x25 ,0x81 ,0x22 ,0x73 ,0x0a ,0x0d ,
0xaa ,0x52 ,0x4f ,0x39 ,0x81 ,0x4b ,0xa9 ,0xf0 ,0x9a ,0xd0 ,0x3e ,0x91 ,0x7a ,0x3b ,0xec ,0x19 ,
0xdc ,0xaf ,0x8a ,0x2e ,0x3e ,0xb6 ,0x6e ,0x12 ,0x1c ,0x97 ,0x4b ,0x93 ,0x3e ,0xe4 ,0x41 ,0x9e]);


final Uint8List hardcodePlain = Uint8List.fromList([0x54,0x65,0x73,0x74,0x41,0x72,0x6D,0x2E,0x54,0x65,0x73,0x74,0x41,0x72,0x6D,0x2E]);


final DynamicLibrary _lib = Platform.isAndroid
    ? DynamicLibrary.open('libaes_hw.so')
    : throw UnsupportedError('Only Android supported');

typedef _aes_encrypt_c = Void Function(
  Pointer<Uint8>,
  Pointer<Uint8>,
  Pointer<Uint8>,
);

typedef _aes_encrypt_dart = void Function(
  Pointer<Uint8>,
  Pointer<Uint8>,
  Pointer<Uint8>,
);

final _aesEncrypt =
    _lib.lookupFunction<_aes_encrypt_c, _aes_encrypt_dart>('aes256_encrypt_block_arm');

Uint8List aesEncrypt() {
  final inPtr = malloc<Uint8>(16);
  final keyPtr = malloc<Uint8>(15 * 16);
  final outPtr = malloc<Uint8>(16);

  //inPtr.asTypedList(16).setAll(0, input);
  inPtr.asTypedList(16).setAll(0, hardcodePlain);
  keyPtr.asTypedList(240).setAll(0, hardcodedRK);

  _aesEncrypt(outPtr, inPtr, keyPtr);

  final out = Uint8List.fromList(outPtr.asTypedList(16));

  malloc.free(inPtr);
  malloc.free(keyPtr);
  malloc.free(outPtr);

  return out;
}
